name: Deploy CeesarCode

on:
  push:
    branches: 
      - main
      - gamma
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'gamma'
        type: choice
        options:
          - gamma
          - prod

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and test
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Build Executor
        run: cd src/executor && cargo build --release

      - name: Build Backend
        run: cd src/backend && go mod tidy && go build -o ../../bin/server .

      - name: Install Frontend Dependencies
        run: cd src/frontend && npm ci

      - name: Build Frontend
        run: cd src/frontend && npm run build

      - name: Run Tests
        run: |
          echo "Running basic health check tests..."
          # Add actual tests here

  # Deploy to Gamma (pre-production)
  deploy-gamma:
    name: Deploy to Gamma
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/gamma' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'gamma')
    environment: gamma
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Gamma Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./config/Dockerfile.gamma
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:gamma
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:gamma-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Deploy to Render (example - can be swapped for Railway, Fly.io, etc.)
      - name: Deploy to Render
        if: ${{ secrets.RENDER_API_KEY != '' }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"serviceId": "${{ secrets.RENDER_GAMMA_SERVICE_ID }}"}' \
            https://api.render.com/v1/services/${{ secrets.RENDER_GAMMA_SERVICE_ID }}/deploys

      # Alternative: Deploy to Fly.io
      - name: Deploy to Fly.io
        if: ${{ secrets.FLY_API_TOKEN != '' && secrets.RENDER_API_KEY == '' }}
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Fly Deploy Gamma
        if: ${{ secrets.FLY_API_TOKEN != '' && secrets.RENDER_API_KEY == '' }}
        run: flyctl deploy --config fly.gamma.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Verify Gamma Deployment
  verify-gamma:
    name: Verify Gamma Deployment
    runs-on: ubuntu-latest
    needs: deploy-gamma
    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Health Check
        run: |
          # Replace with your gamma URL
          GAMMA_URL="${{ secrets.GAMMA_URL || 'https://gamma.ceesarcode.example.com' }}"
          
          echo "Testing gamma deployment at $GAMMA_URL..."
          
          # Test API endpoint
          curl -f "$GAMMA_URL/api/problems" || echo "API test failed (may need URL configuration)"
          
          echo "âœ… Gamma deployment verification complete"

      - name: Run Smoke Tests
        run: |
          GAMMA_URL="${{ secrets.GAMMA_URL || 'https://gamma.ceesarcode.example.com' }}"
          
          echo "Running smoke tests..."
          
          # Test problem listing
          curl -s "$GAMMA_URL/api/problems" | head -c 500 || true
          
          # Test Python execution
          echo "Testing Python execution..."
          curl -X POST "$GAMMA_URL/api/run" \
            -H "Content-Type: application/json" \
            -d '{"language":"python","files":{"Main.py":"print(\"Hello from gamma!\")"}}' \
            || echo "Python test skipped (endpoint may not be available)"

  # Deploy to Production
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install dependencies
        run: cd src/frontend && npm ci

      - name: Build frontend
        run: cd src/frontend && npm run build

      - name: Deploy Frontend to Cloudflare Pages
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ceesarcode
          directory: src/frontend/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Fly.io CLI
        if: ${{ secrets.FLY_API_TOKEN != '' }}
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Backend to Fly.io
        if: ${{ secrets.FLY_API_TOKEN != '' }}
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Verify Production Deployment
  verify-prod:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    needs: deploy-prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for deployment
        run: sleep 60

      - name: Test Languages
        run: |
          PROD_URL="${{ secrets.PROD_URL || 'https://ceesarcode.fly.dev' }}"
          
          echo "Testing Python..."
          curl -X POST "$PROD_URL/api/submit" \
            -H "Content-Type: application/json" \
            -d '{"problemId":"float-mean","language":"python","files":{"Main.py":"print(2.0)"}}'
          
          echo "Testing JavaScript..."
          curl -X POST "$PROD_URL/api/submit" \
            -H "Content-Type: application/json" \
            -d '{"problemId":"float-mean","language":"javascript","files":{"main.js":"console.log(\"2.0\")"}}'
          
          echo "Testing C++..."
          curl -X POST "$PROD_URL/api/submit" \
            -H "Content-Type: application/json" \
            -d '{"problemId":"float-mean","language":"cpp","files":{"Main.cpp":"#include<iostream>\nusing namespace std;\nint main(){cout<<\"2.0\";return 0;}"}}'
